package multithread;

import java.util.Arrays;
import java.util.Iterator;
import java.util.List;
import java.util.concurrent.Phaser;

public class PhaserDemo {

	public PhaserDemo() {
		// TODO Auto-generated constructor stub
	}

	public static void main(String[] args) {
		// создание коллекцию товаров
		 Item[] goods = new Item[20];
		 for (int i = 0; i < goods.length; i++) {
		 goods[i] = new Item(i + 1);
		 }
		 List<Item> listGood = Arrays.asList(goods);
		 // создание склада, из которого забирают товары
		 Storage storageA = Storage.createStorage(listGood.size(), listGood);
		 // создание склада, куда перевоз€т товары
		 Storage storageB = Storage.createStorage(listGood.size());
		 // создание фазера дл€ синхронизации движени€ колонны грузовиков
		 Phaser phaser = new Phaser();
		 phaser.register();
		 int currentPhase;
		 // создание колонны грузовиков
		 Thread tr1 = new Thread(new Truck(phaser, "tr1", 5, storageA, storageB));
		 Thread tr2 = new Thread(new Truck(phaser, "tr2", 6, storageA, storageB));
		 Thread tr3 = new Thread(new Truck(phaser, "tr3", 7, storageA, storageB));
		printGoodsToConsole("“овары на складе A", storageA);
		printGoodsToConsole("“овары на складе B", storageB);
		 // запуск колонны грузовиков на загрузку на одном складе + поездку +
		 // разгрузку на другом складе
		 tr1.start();
		 tr2.start();
		 tr3.start();
		 // синхронизаци€ загрузки
		 currentPhase = phaser.getPhase();
		 phaser.arriveAndAwaitAdvance();
		 System.out.println("«агрузка колонны завершена. ‘аза " + currentPhase
		+ " завершена.");
		 // синхронизаци€ поездки
		 currentPhase = phaser.getPhase();
		 phaser.arriveAndAwaitAdvance();
		 System.out.println("ѕоездка колонны завершена. ‘аза " + currentPhase
		+ " завершена.");
		 // синхронизаци€ разгрузки
		 currentPhase = phaser.getPhase();
		 phaser.arriveAndAwaitAdvance();
		 System.out.println("–азгрузка колонны завершена. ‘аза " + currentPhase
		+ " завершена.");
		 phaser.arriveAndDeregister();
		 if (phaser.isTerminated()) {
		System.out.println("‘азы синхронизированы и завершены.");
		 }
		printGoodsToConsole("“овары на складе A", storageA);
		printGoodsToConsole("“овары на складе B", storageB);

	}
	
	public static void printGoodsToConsole(String title, Storage storage) {
		 System.out.println(title);
		 Iterator<Item> goodIterator = storage.iterator();
		 while (goodIterator.hasNext()) {
		 System.out.print(goodIterator.next().getRegistrationNumber() + " ");
		 }
		 System.out.println();
		}

}
